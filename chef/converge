#!/bin/sh -e
# to bootstrap do
# g=github.com; sudo apt update && sudo apt install -y git && mkdir $g && ln -s $g/stuart-system/chef && cd $g && git clone https://$g/stuart12/stuart-system.git && stuart-system/chef/converge
# then create a attributes/5xxxx.rb file for your uuid and hostname etc
chef=/usr/bin/chef-solo
[ -x $chef ] || { sudo apt update && sudo apt install -y chef; }
DIR=$(dirname $(readlink -f $0))
recipes=""
for i
do
	recipes="${recipes},recipe[op::$i]"
done
if [ ! -r $DIR/roles/secrets.rb ]; then
	echo "name 'secrets'" > $DIR/roles/secrets.rb
fi
dirty=$(cd $DIR && git status -s | cut -c 4-)
if [ -n "$dirty" ]; then
	rubocop --auto-correct $dirty
fi
sudo $chef --config $DIR/solo.rb --json-attributes $DIR/solo.json ${recipes:+-o role[secrets],role[quick]$recipes}
if [ -n "$dirty" ]; then
	foodcritic $DIR/cookbooks
fi

# chef-shell --solo -z --config $PWD/solo.rb --json-attributes $PWD/solo.json
