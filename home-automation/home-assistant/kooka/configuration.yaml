# home assistant configuration for the central server
---
homeassistant:
  name: kooka
  unit_system: metric
  time_zone: Europe/Paris
  latitude: 48.839548
  longitude: 2.395671
  elevation: 36

history:  # Enables support for tracking state changes over time.
updater:  # Checks for available updates
logbook:  # View all events in a logbook
config:  # Enables configuration UI
frontend:  # Enables the frontend

mqtt:
  username: skldhf84d
  password: !secret mqtt
  client_id: kooka
  broker: stuartpi3

http:
  api_password: !secret http
  trusted_networks:
    - 127.0.0.1

media_player:
  - platform: spotify
    client_id: !secret spotify_client
    client_secret: !secret spotify_secret
  - platform: mpd
    host: 192.168.0.8
    password: !secret mpd_passwd

#  mqtt_eventstream:
#    publish_topic: master/kooka
#    subscribe_topic: slaves/bedroom

mqtt_statestream:
  base_topic: salon

# https://home-assistant.io/cookbook/perform_actions_based_on_input_select/
input_select:
  radio_station:
    name: Radio Station
    options:
      - RFI Monde
      - France Culture
      - ABC Radio National MP3
      - France Info
      - BBC World Service (AAC)
      - Public Radio International PRI 24 Hour Stream
      - Audiophile Jazz
      - Audiophile Classical
      - FIP
      - Ch√©rie FM
      - Radio Tram
      - Radio 9090 90.9
      - Nogoum FM 100.6
      - 181.FM - Vocal Jazz
      - '#1 Jazz Radio'
      - '.977 Smooth Jazz'
      - None
    initial: None
    icon: mdi:radio

automation:
  - alias: Clear radio choice on MPD stop
    trigger: # https://home-assistant.io/docs/automation/trigger/
      - platform: state
        entity_id: media_player.mpd
        to: 'paused'
    action:
        service: input_select.select_option
        data: # https://home-assistant.io/components/input_select/
          entity_id: input_select.radio_station
          option: None
  - alias: Stop Spotify on mpd Start
    trigger: # https://home-assistant.io/docs/automation/trigger/
      - platform: state
        entity_id: media_player.mpd
        to: 'playing'
    action:
      - service: media_player.media_pause
        data:
          entity_id: media_player.spotify
  - alias: Stop MPD on Spotify Start
    trigger: # https://home-assistant.io/docs/automation/trigger/
      - platform: state
        entity_id: media_player.spotify
        to: 'playing'
    action:
      - service: media_player.media_pause
        data:
          entity_id: media_player.mpd
  - alias: telephone
    trigger:
      - platform: mqtt
        topic: 'telephone'
    action: # https://community.home-assistant.io/t/passing-variables-from-mqtt-trigger-payload-to-shell-script/23047/4
      - service_template: shell_command.telephone_{{ trigger.payload }}
  - alias: radio mqtt message
    trigger:
      - platform: mqtt
        topic: 'radio'
    action: # https://community.home-assistant.io/t/passing-variables-from-mqtt-trigger-payload-to-shell-script/23047/4
      - service: shell_command.radio_info
        data_template:
          value: '{{ trigger.payload }}'
  - alias: Play Spotify
    trigger:
      - platform: mqtt
        topic: 'message'
        payload: 'spotify play'
    action:
      - service: media_player.select_source
        data: #  https://community.home-assistant.io/t/spotify-ignoring-source/18588
          entity_id: media_player.spotify
          source: 47spots
      - service: media_player.media_play
        data:
          entity_id: media_player.spotify
  - alias: Play Democracy Now
    trigger:
      - platform: mqtt
        topic: 'message'
        payload: 'democracynow'
    action:
      - service: shell_command.democracynow
  - alias: Play Podcast
    trigger:
      - platform: mqtt
        topic: 'message'
        payload: 'playnewestpod'
    action:
      - service: shell_command.playnewestpod
  - alias: message_leaving
    trigger:
      - platform: mqtt
        topic: 'message'
        payload: 'leaving'
    action:
      - service: media_player.media_pause
        data:
          entity_id: media_player.spotify
      - service: media_player.media_pause
        data:
          entity_id: media_player.mpd
  - alias: Amps Off
    trigger:
      - platform: mqtt
        topic: 'message'
        payload: 'amps off'
    action:
      - service: media_player.media_pause
        data:
          entity_id: media_player.spotify
      - service: media_player.media_pause
        data:
          entity_id: media_player.mpd
  - alias: bedroom clock
    trigger:
      - platform: event
        event_type: bedroom.switch.delcom_clock.state
    action:
      service: media_player.turn_off
  - alias: Choose From Radio List
    trigger:
      - platform: state
        entity_id: input_select.radio_station # https://home-assistant.io/components/input_select/
    action:
      - service: shell_command.radio_info
        data_template:
          value: '{{ states.input_select.radio_station.state }}'
script:
  living_volume_down:
    alias: Living Volume Down
    sequence:
      - service: mqtt.publish
        data:
          topic: 'message'
          payload: 'living volume down'
  living_volume_up:
    alias: Living Volume Up
    sequence:
      - service: mqtt.publish
        data:
          topic: 'message'
          payload: 'living volume up'
  living_on:
    alias: Living Amplifier On
    sequence:
      - service: mqtt.publish
        data:
          topic: 'message'
          payload: 'amplifier living on'
  living_off:
    alias: Living Amplifier Off
    sequence:
      - service: mqtt.publish
        data:
          topic: 'message'
          payload: 'amplifier living off'
  telephone_off:
    alias: Telephone Sleep
    sequence:
      - service: shell_command.telephone_sleep
  telephone_on:
    alias: Telephone Awake
    sequence:
      - service: shell_command.telephone_awake

shell_command:
  telephone_sleep: 'adb shell -n -T am broadcast -a it.pook.easer.control -c sleep'
  telephone_awake: 'adb shell -n -T am broadcast -a it.pook.easer.control -c awake'
  radio_info: 'radioinfo_mpd.py "{{ value }}"'
  playnewestpod: 'playnewestpod'
  democracynow: 'playnewestpod http://www.democracynow.org/podcast.xml'

logger: # https://home-assistant.io/docs/mqtt/logging/
  default: info
  logs:
    homeassistant.components.mqtt: warn
    homeassistant.components.shell_command: debug

binary_sensor:  # https://home-assistant.io/components/binary_sensor.mqtt/
  - name: VMC
    platform: mqtt
    state_topic: "server/vmc/switch"
    payload_on: 'on'
    payload_off: 'off'
  - name: Is Holiday
    platform: mqtt
    state_topic: "states/is_holiday"
    payload_on: 'on'
    payload_off: 'off'
