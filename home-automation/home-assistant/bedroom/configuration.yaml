# home assistant configuration for server in bedroom
# Stuart Pook, 2018 (http://www.pook.it/)
---
homeassistant:
  # Name of the location where Home Assistant is running
  name: bedroom
  # Location required to calculate the time the sun rises and sets
  latitude: 48.839548
  longitude: 2.395671
  # Impacts weather/sunrise data (altitude above sea level in meters)
  elevation: 36
  unit_system: metric
  time_zone: Europe/Paris

frontend: # Enables the frontend
config: # Enables configuration UI
updater:  # Checks for available updates

http:
  #api_password: !secret http
  server_host: 127.0.0.1
  trusted_networks:
    - 127.0.0.1

# https://home-assistant.io/components/mqtt_eventstream/
#mqtt_eventstream:
  #publish_topic: slaves/bedroom
  #subscribe_topic: master/kooka

# https://home-assistant.io/components/mqtt_statestream/
#mqtt_statestream:
#  base_topic: bedroom

light:
  - platform: blinksticklight
    serial: BS015348-3.0
    name: bedroom

mqtt:
  username: skldhf84d
  password: !secret mqtt
  broker: localhost
  client_id: stuartpi3
  protocol: 3.1.1

# sudo evtest /dev/input/by-id/usb-ORTEK_USB_Keyboard_Hub-event-kbd
keyboard_remote:
  device_name: 'ORTEK USB Keyboard Hub'
  type: 'key_down'

automation:
  - alias: Wakeup
    trigger:
      - platform: time
        at: !secret alarm_time
    action:
      - service: script.telephone_awake
      - service: switch.turn_on
        entity_id: switch.delcom_clock
      - delay: '00:00:10'
      - service: script.bedside_white
      - delay: '00:00:10'
      - service: input_number.set_value
        data_template:
          entity_id: input_number.volume
          value: 56
      - service: mqtt.publish
        data:
          topic: 'radio'
          payload: 'France Culture'
      - service: switch.turn_on
        entity_id: switch.amplifier
      - delay: '00:00:10'
      - service: input_number.set_value
        data_template:
          entity_id: input_number.volume
          value: 70
      - delay: '00:00:30'
      - service: script.buzz_phone
      - delay: '00:01:00'
      - service: mqtt.publish
        data:
          topic: 'message'
          payload: 'amplifier living on'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.is_holiday
          state: 'off'
        - condition: time
          weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
        - condition: template
          value_template: '{{ is_state("switch.delcom_clock", "off") }}'
  - alias: Leave Home
    trigger:
      - platform: time
        at: !secret leaving_time
    action:
      - service: mqtt.publish
        data:
          topic: 'message'
          payload: 'amps off'
      - service: script.bedside_off
      - delay: '00:02:11' # 00:01:11 was not enough
      - service: script.bedside_off
      - delay: '00:02:11'
      - service: script.bedside_off
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.is_holiday
          state: 'off'
        - condition: time
          weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
        - condition: template
          value_template: '{{ is_state("switch.delcom_clock", "on") }}'
  - alias: France Culture (2)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 108 # KEY_DOWN ('2') without numlock
    action:
      - service: script.telephone_awake
      - service: mqtt.publish
        data:
          topic: 'radio'
          payload: 'France Culture'
# code 109 (KEY_PAGEDOWN) 3
  - alias: BBC World Service (3)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 109 # KEY_PAGEDOWN 3
    action:
      - service: script.telephone_awake
      - service: mqtt.publish
        data:
          topic: 'radio'
          payload: 'BBC World Service (AAC)'
# code 74 (KEY_KPMINUS)
  - alias: Volume Down (−)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 74 # KEY_KPMINUS (−)
    action:
      - service: switch.turn_on
        entity_id: switch.amplifier
      - service: input_number.set_value
        data_template:
          entity_id: input_number.volume
          value: "{{ states('input_number.volume') | int - 1 }}"
# code 78 (KEY_KPPLUS)
  - alias: Volume Up (+)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 78 # KEY_KPPLUS (+)
    action:
      - service: switch.turn_on
        entity_id: switch.amplifier
      - service: input_number.set_value
        data_template:
          entity_id: input_number.volume
          value: "{{ states('input_number.volume') | int + 1 }}"
  - alias: BBC 4 (4)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 105 # (KEY_LEFT) '4'
    action:
      - service: script.telephone_awake
      - service: mqtt.publish
        data:
          topic: 'radio'
          payload: 'BBC Radio 4'
  - alias: Spotify (6)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 106 # "(KEY_RIGHT) '6'
    action:
      - service: script.telephone_awake
      - service: mqtt.publish
        data:
          topic: 'message'
          payload: 'spotify play'
# code 102 (KEY_HOME) '7'
# code 104 (KEY_PAGEUP) '9'
  - alias: Amp Off (9)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 104 # "9" without numlock
    action:
      - entity_id: switch.amplifier
        service: switch.turn_off
  - alias: RFI Monde (1)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 107 # "1" without numlock
    action:
      - service: script.telephone_awake
      - service: mqtt.publish
        data:
          topic: 'radio'
          payload: 'RFI Monde'
  - alias: Amplifier Living Off (/)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 98 # "KEY_KPSLASH" without numlock
    action:
      - service: mqtt.publish
        data:
          topic: 'message'
          payload: 'amplifier living off'
  - alias: Amplifier Living On (*)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 55 # "KEY_KPASTERISK" without numlock
    action:
      - service: script.telephone_awake
      - service: mqtt.publish
        data:
          topic: 'message'
          payload: 'amplifier living on'
  - alias: Sleep (←)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 14 # "KEY_BACKSPACE" without numlock
    action:
      - service: script.telephone_sleep
      - service: switch.turn_off
        entity_id: switch.delcom_clock
      - service: mqtt.publish
        data:
          topic: 'message'
          payload: 'amps off'
  - alias: Swap clock status (0)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 110 # "0" without numlock
    action:
      service: script.toggle_clock
  - alias: Toggle LED red (⏎)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 28 # return without numlock
    action:
      - service: script.toggle_bedside_red

  - alias: Toggle LED White (·)
    trigger:
      platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 111 # "." without numlock
    action:
      - service: script.toggle_bedside_white

  - alias: Publish Is Holiday State
    trigger:  # https://home-assistant.io/docs/automation/trigger/
      - platform: state
        entity_id: binary_sensor.is_holiday
      - platform: homeassistant
        event: start
    action:
      - service: mqtt.publish
        data_template:
          retain: true
          topic: "states/is_holiday"
          payload: "{{ states('binary_sensor.is_holiday') }}"
  - alias: Adjust Volume to Slider
    trigger:
      platform: state
      entity_id: input_number.volume
    action:
      - service: shell_command.set_volume_to_slider
  - alias: Adjust Slider to Volume
    trigger:
      platform: state
      entity_id: sensor.amp2
    action:
      service: input_number.set_value
      data_template:
        entity_id: input_number.volume
        value: "{{ states('sensor.amp2') }}"
  - alias: message_leaving
    trigger:
      - platform: mqtt
        topic: 'message'
        payload: 'leaving'
    action:
      - entity_id: switch.amplifier
        service: switch.turn_off
  - alias: Amps Off
    trigger:
      - platform: mqtt
        topic: 'message'
        payload: 'amps off'
    action:
      - entity_id: switch.amplifier
        service: switch.turn_off

sensor:
  - platform: command_line
    command: 'amixer get Digital | sed -ne "/Front Left/s/.* \[\([0-9]*\)%.*/\1/p"'
    name: amp2
    unit_of_measurement: '%'
    scan_interval: 4

input_number:
  volume:
    min: 50
    initial: 70
    max: 100
    step: 1

switch:
  - platform: command_line
    switches:
      amplifier:
        command_on: 'amixer -q set Digital unmute'
        command_off: 'amixer -q set Digital mute'
        command_state: 'amixer get Digital | fgrep -q "[on]"'
        friendly_name: Amplifier
      delcom_clock:
        command_on: 'delcom-control --on; sleep 1'
        command_off: 'delcom-control --off; sleep 1'
        command_state: 'cat /sys/bus/usb/drivers/usbsevseg/*/text'
        value_template: '{{ value != "\0" }}'
        friendly_name: Bedroom Led

shell_command:
  set_volume_to_slider: 'amixer -q set Digital {{ states.input_number.volume.state }}%'
  swap: 'delcom-control --swap &'
  alarm_stop: 'alarm-stop &'
  blink: 'delcom-control --blink &'
  led_on: 'delcom-control --on &'
  buzz_phone: buzz_phone --ring_time 10 {{ args }}

# https://home-assistant.io/docs/mqtt/logging/
logger:
  default: warn
  logs:
    homeassistant.components.mqtt: debug

# https://community.home-assistant.io/t/toggle-a-hue-go-for-a-specific-color-or-scene/11449/4
script:
  buzz_phone:
    alias: ring the phone
    sequence:
      - service: shell_command.buzz_phone
        data:
          args: !secret buzz_phone
  telephone_sleep:
    alias: Telephone Sleep
    sequence:
      - service: mqtt.publish
        data:
          topic: 'telephone'
          payload: 'sleep'
  telephone_awake:
    alias: Telephone Awake
    sequence:
      - service: mqtt.publish
        data:
          topic: 'telephone'
          payload: 'awake'
  toggle_clock:
    sequence:
    - service_template: switch.turn_{% if is_state('switch.delcom_clock', 'off') %}on{% else %}off{% endif %}

  toggle_bedside_red:
    sequence:
    - service_template: script.bedside_{% if is_state('light.bedroom', 'off') %}red{% else %}off{% endif %}

  toggle_bedside_white:
    sequence:
    - service_template: script.bedside_{% if is_state('light.bedroom', 'off') %}white{% else %}off{% endif %}

  bedside_red:
    sequence:
    - service: light.turn_on
      entity_id: light.bedroom
      data:
        color_name: red
        brightness_pct: 100

  bedside_white:
    sequence:
    - service: light.turn_on
      entity_id: light.bedroom
      data_template:
        color_name: "{% if is_state('binary_sensor.is_holiday', 'on') %}green{% else %}white{% endif %}"
        brightness_pct: 100
    - delay: '00:00:02'
    - service: light.turn_on
      entity_id: light.bedroom
      data:
        color_name: white
        brightness_pct: 100

  bedside_off:
    sequence:
    - service: light.turn_off
      entity_id: light.bedroom

recorder: # https://home-assistant.io/components/recorder/
  purge_interval: 1
  purge_keep_days: 30
# exclude: # https://home-assistant.io/docs/backend/database/

binary_sensor:
  - platform: onholidays
    name: Is Holiday
    friendly_name: Not_Used_Friendly_Name
    alias: Not_Used_Alias
    filename: /home/homeassistant/holidays
    offset: 7 # (hours) so that I can check if tomorrow is a holiday before I go to bed
    scan_interval: 600 # I don't change the file very often
